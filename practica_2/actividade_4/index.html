<!DOCTYPE html>
<html class="writer-html5" lang="pt_BR" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Xoan C. Pardo" /><link rel="canonical" href="https://miot-cniot.github.io/practica_2/actividade_4/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Actividade 4 - Computación na Nube para IoT</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Actividade 4";
        var mkdocs_page_input_path = "practica_2/actividade_4.md";
        var mkdocs_page_url = "/practica_2/actividade_4/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Computación na Nube para IoT
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Actividades adicionais</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Práctica 1</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_1/actividade_1/">Actividade 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_1/actividade_2/">Actividade 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_1/actividade_3/">Actividade 3</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Práctica 2</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../actividade_1/">Actividade 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../actividade_2/">Actividade 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../actividade_3/">Actividade 3</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Actividade 4</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#obxectivo">Obxectivo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#creacion-da-sombra-de-dispositivo">Creación da sombra de dispositivo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuracion-do-exemplo">Configuración do exemplo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#proba-do-exemplo">Proba do exemplo</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#estado-inicial-da-sombra">Estado inicial da sombra</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cambio-de-estado-no-dispositivo-iot">Cambio de estado no dispositivo IoT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cambio-de-estado-na-sombra-co-dispositivo-iot-conectado">Cambio de estado na sombra co dispositivo IoT conectado</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cambio-de-estado-na-sombra-co-dispositivo-iot-desconectado">Cambio de estado na sombra co dispositivo IoT desconectado</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#xustificacion-da-actividade">Xustificación da actividade</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#creacion-da-sombra-de-dispositivo_1">Creación da sombra de dispositivo</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configuracion-do-exemplo_1">Configuración do exemplo</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#proba-do-exemplo_1">Proba do exemplo</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#estado-inicial-da-sombra_1">Estado inicial da sombra</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#cambio-de-estado-no-dispositivo-iot_1">Cambio de estado no dispositivo IoT</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#cambio-de-estado-na-sombra-co-dispositivo-iot-conectado_1">Cambio de estado na sombra co dispositivo IoT conectado</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#cambio-de-estado-na-sombra-co-dispositivo-iot-desconectado_1">Cambio de estado na sombra co dispositivo IoT desconectado</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Práctica 3</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_3/actividade_1/">Actividade 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_3/actividade_2/">Actividade 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_3/actividade_3/">Actividade 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_3/actividade_4/">Actividade 4</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Práctica 4</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_4/actividade_1/">Actividade 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../practica_4/actividade_2/">Actividade 2</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Computación na Nube para IoT</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Práctica 2</li>
      <li class="breadcrumb-item active">Actividade 4</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="actividade-4">Actividade 4</h1>
<p><strong>EXECUTAR O EXEMPLO DE SOMBRAS DE DISPOSITIVO DA DEVICE SDK V2.</strong></p>
<h2 id="obxectivo">Obxectivo</h2>
<p>O obxectivo desta actividade é probar un dos exemplos que veñen coa versión 2 do Device SDK.</p>
<ul>
<li>
<p>O exemplo que vamos a probar utiliza o servizo <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html">AWS IoT Device Shadow</a> para manter o valor dunha propiedade sincronizado entre o dispositivo IoT e o servidor.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Podes ver <a href="https://github.com/aws/aws-iot-device-sdk-python-v2/blob/main/samples/shadow_mqtt5.md">aquí</a> a documentación do exemplo.</p>
</div>
</li>
</ul>
<h2 id="creacion-da-sombra-de-dispositivo">Creación da sombra de dispositivo</h2>
<p>Para crear unha sombra de dispositivo fai o seguinte:</p>
<ol>
<li>Abre a consola AWS IoT e no menú lateral, dentro do submenú <strong>Todos os dispositivos</strong>, escolle a opción <strong>Cousas</strong>.</li>
<li>Abre as propiedades da cousa <strong>truckSensor01</strong> e na aba <strong>Sombras de dispositivo</strong> escolle <strong>Crear sombra de dispositivo</strong>. </li>
<li>Escolle o tipo <strong>Sombra sen nome (clásico)</strong> e acepta para crear a sombra.</li>
</ol>
<p><img alt="Sombra do dispositivo" src="../imgs/awsiot-thing-shadow.png" />
<em>Imaxe: sombra do dispositivo <strong>truckSensor01</strong>.</em></p>
<h2 id="configuracion-do-exemplo">Configuración do exemplo</h2>
<p>Para configurar o exemplo fai o seguinte:</p>
<ol>
<li>No directorio de <em>scripts</em> do ambiente Cloud9, crea un <em>script</em> <strong>shadow.sh</strong> para executar o exemplo. Vamos a controlar a través da sombra o valor da propiedade <strong>door</strong> do camión.</li>
</ol>
<div class="admonition important">
<p class="admonition-title">Nomenclatura</p>
<p><strong>Lembra usar o teu prefixo</strong> no nome da cousa.</p>
</div>
<pre><code>$ cd ~/environment/scripts
$ nano shadow.sh
$ cat shadow.sh
#!/usr/bin/env bash

# stop script on error
set -e

# set the thing name
thing=xcpm2425-truckSensor01

# get the MQTT5-compatible AWS IoT endpoint
aws iot describe-endpoint \
  --endpoint-type iot:Data-ATS &gt; /tmp/iotendpoint.json
iot_endpoint=$(jq -r &quot;.endpointAddress&quot; /tmp/iotendpoint.json)

# run shadow MQTT5 sample app
printf &quot;\nRunning MQTT5 device shadow sample application with $thing thing...\n&quot;
python3 ./aws-iot-device-sdk-python-v2/samples/shadow_mqtt5.py \
  --endpoint $iot_endpoint \
  --ca_file ../certs/root-CA1.crt \
  --cert ../certs/$thing.cert.pem \
  --key ../certs/$thing.private.key \
  --thing_name $thing \
  --shadow_property door
$
</code></pre>
<ol start="4">
<li>Edita a política AWS IoT da cousa <strong>truckSensor01</strong> para permitir a subscrición aos tópicos da sombra e publicar e recibir mensaxes neles.</li>
</ol>
<div class="admonition important">
<p class="admonition-title">OLLO</p>
<p>Lembra usar o ID da túa conta nos ARN (<em>Amazon Resource Name</em>) dos recursos.</p>
</div>
<p><img alt="Política AWS IoT" src="../imgs/aws_iot_shadowpolicy.png" />
<em>Imaxe: política AWS IoT modificada.</em></p>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma as capturas 1 a 3 que se piden para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<h2 id="proba-do-exemplo">Proba do exemplo</h2>
<h3 id="estado-inicial-da-sombra">Estado inicial da sombra</h3>
<p>Para configurar o estado inicial da sombra fai o seguinte:</p>
<ol>
<li>Nas propiedades da cousa <strong>truckSensor01</strong>, escolle a aba <strong>Sombras de dispositivo</strong> e abre as propiedades da sombra premendo no seu nome.</li>
<li>Na aba <strong>Documento da sombra de dispositivo</strong> das propiedades da sombra podes consultar o estado inicial da sombra.</li>
</ol>
<p><img alt="Estado inicial da sombra" src="../imgs/aws_iot_shadowstate01.png" />
<em>Imaxe: estado inicial da sombra.</em></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Polo dagora a propiedade <strong>door</strong> non forma parte do estado da sombra.</p>
</div>
<ol start="3">
<li>Na aba <strong>Tópicos MQTT</strong> das propiedades da sombra escolle <strong>Cliente de proba MQTT</strong> para abrir unha nova xanela do cliente MQTT con subscricións xa configuradas aos tópicos da sombra.</li>
</ol>
<p><img alt="Cliente de proba MQTT" src="../imgs/aws_iot_mqttclient01.png" />
<em>Imaxe: cliente de proba MQTT con subscricións aos tópicos da sombra.</em></p>
<ol start="4">
<li>Executa o exemplo no directorio de <em>scripts</em>.</li>
</ol>
<pre><code>$ pwd
/home/ec2-user/environment/scripts
$ chmod +x shadow.sh
$ ./shadow.sh
</code></pre>
<p>O <em>script</em> fai o seguinte:</p>
<ul>
<li>Conéctase aos tópicos da sombra.</li>
<li>Consulta o estado da sombra para coñecer que valor ten a propiedade <strong>door</strong>.</li>
<li>Como a propiedade non existe, inicializa a propiedade <strong>door</strong> ao valor por defecto <strong>off</strong> e solicita a actualización do estado da sombra informando do valor actual da propiedade <strong>door</strong>.</li>
<li>Queda agardando a que se insira un novo valor para a propiedade.</li>
</ul>
<p><img alt="Saida do script" src="../imgs/cloud9_shadowsh01.png" />
<em>Imaxe: saida da execución do script <strong>shadow.sh</strong>.</em></p>
<ol start="5">
<li>Comproba no cliente MQTT as mensaxes intercambiadas nos tópicos da sombra. Haberá 3 tópicos que conteñan mensaxes.</li>
</ol>
<p><img alt="Tópicos da sombra con mensaxes" src="../imgs/aws_iot_mqttclient02.png" />
<em>Imaxe: tópicos da sombra nos que se recibiron mensaxes.</em></p>
<ol start="6">
<li>Comproba as mensaxes en cada tópico:</li>
</ol>
<ul>
<li><code>$aws/things/truckSensor01/shadow/get/accepted</code>: a consulta inicial do estado da sombra.</li>
</ul>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;welcome&quot;: &quot;aws-iot&quot;
    },
    &quot;reported&quot;: {
      &quot;welcome&quot;: &quot;aws-iot&quot;
    }
  },
  &quot;metadata&quot;: {
    &quot;desired&quot;: {
      &quot;welcome&quot;: {
        &quot;timestamp&quot;: 1722081284
      }
    },
    &quot;reported&quot;: {
      &quot;welcome&quot;: {
        &quot;timestamp&quot;: 1722081284
      }
    }
  },
  &quot;version&quot;: 10,
  &quot;timestamp&quot;: 1722081623,
  &quot;clientToken&quot;: &quot;8e24e173-99d3-40bc-8613-e86973df4255&quot;
}
</code></pre>
<ul>
<li><code>$aws/things/truckSensor01/shadow/update/accepted</code>: a solicitude de actualización do estado da sombra.</li>
</ul>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;off&quot;
    },
    &quot;reported&quot;: {
      &quot;door&quot;: &quot;off&quot;
    }
  },
  &quot;metadata&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: {
        &quot;timestamp&quot;: 1722081623
      }
    },
    &quot;reported&quot;: {
      &quot;door&quot;: {
        &quot;timestamp&quot;: 1722081623
      }
    }
  },
  &quot;version&quot;: 11,
  &quot;timestamp&quot;: 1722081623,
  &quot;clientToken&quot;: &quot;eebdd795-9d62-46ab-83af-a858527ae0a2&quot;
}
</code></pre>
<ul>
<li><code>$aws/things/truckSensor01/shadow/update/documents</code>: a actualización do estado, que agora pasa a conter a propiedade <strong>door</strong> co valor informado polo dispositivo IoT.</li>
</ul>
<pre><code>{
  &quot;previous&quot;: {
    &quot;state&quot;: {
      &quot;desired&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;
      }
    },
    &quot;metadata&quot;: {
      &quot;desired&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        }
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        }
      }
    },
    &quot;version&quot;: 10
  },
  &quot;current&quot;: {
    &quot;state&quot;: {
      &quot;desired&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;,
        &quot;door&quot;: &quot;off&quot;
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;,
        &quot;door&quot;: &quot;off&quot;
      }
    },
    &quot;metadata&quot;: {
      &quot;desired&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        },
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722081623
        }
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        },
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722081623
        }
      }
    },
    &quot;version&quot;: 11
  },
  &quot;timestamp&quot;: 1722081623,
  &quot;clientToken&quot;: &quot;eebdd795-9d62-46ab-83af-a858527ae0a2&quot;
}
</code></pre>
<ol start="7">
<li>Nas propiedades da sombra, actualiza as propiedades e comproba como se fixeron efectivos os cambios no documento de estado.</li>
</ol>
<p><img alt="Estado actualizado da sombra" src="../imgs/aws_iot_shadowstate02.png" />
<em>Imaxe: estado actualizado da sombra no que xa aparece a propiedade <strong>door</strong>.</em></p>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma as capturas 4 e 5 que se piden para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<h3 id="cambio-de-estado-no-dispositivo-iot">Cambio de estado no dispositivo IoT</h3>
<p>Para cambiar o estado no dispositivo IoT fai o seguinte:</p>
<ol>
<li>No terminal do ambiente Cloud9 no que está a se executar o <em>script</em> <strong>shadow.sh</strong> escribe o valor <code>on</code>.</li>
</ol>
<p><img alt="Cambio do valor no terminal do script shadow.sh" src="../imgs/cloud9_shadowsh02.png" />
<em>Imaxe: cambio do valor no terminal do script <strong>shadow.sh</strong>.</em></p>
<ol start="2">
<li>
<p>Comproba no cliente MQTT as mensaxes recibidas nos tópicos da sombra. Haberá 2 tópicos que conteñan mensaxes:</p>
<ul>
<li><code>$aws/things/truckSensor01/shadow/update/accepted</code> coa solicitude de actualización do estado da sombra.</li>
<li><code>$aws/things/truckSensor01/shadow/update/documents</code> coa actualización do estado.</li>
</ul>
</li>
<li>
<p>Nas propiedades da sombra, actualiza as propiedades e comproba como se fixeron efectivos os cambios no documento de estado.</p>
</li>
<li>
<p>Proba agora a volver a escribir o valor <code>on</code> no terminal do ambiente Cloud9 no que está a se executar o <em>script</em> <strong>shadow.sh</strong>. Comproba que agora non se envía ningunha mensaxe para solicitar unha actualización do estado da sombra.</p>
</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma as capturas 6 e 7 que se piden para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<h3 id="cambio-de-estado-na-sombra-co-dispositivo-iot-conectado">Cambio de estado na sombra co dispositivo IoT conectado</h3>
<p>Para cambiar o estado da sombra co dispositivo IoT conectado fai o seguinte:</p>
<ol>
<li>Asegúrate de que o <em>script</em> <strong>shadow.sh</strong> estexa a se executar no ambiente Cloud9.</li>
<li>No cliente MQTT publica no tópico <code>$aws/things/truckSensor01/shadow/update</code> a mensaxe seguinte:</li>
</ol>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;off&quot;
    }
  }
}
</code></pre>
<p><img alt="Actualización do estado da sombra no cliente MQTT" src="../imgs/mqtt_topic_update01.png" />
<em>Imaxe: cliente MQTT configurado para publicar unha mensaxe no tópico <code>update</code> da sombra.</em></p>
<ol start="3">
<li>Comproba no cliente MQTT as mensaxes recibidas nos tópicos da sombra. </li>
</ol>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Se a actualización fallou haberá unha mensaxe no tópico <code>$aws/things/truckSensor01/shadow/update/rejected</code> indicando a causa.</p>
</div>
<p>Se a actualización se fixo correctamente haberá 3 tópicos que conteñan mensaxes:</p>
<ul>
<li>No tópico <code>$aws/things/truckSensor01/shadow/update/accepted</code> publicaronse 2 mensaxes. A penúltima das mensaxes é a solicitude de actualización do estado da sombra realizada desde o cliente MQTT. O servizo <strong>Device shadow</strong> incrementou o número de versión e adicionou os valores de <em>timestamp</em> e os metadatos. A procedencia da última mensaxe publicada explícase máis adiante.</li>
</ul>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;off&quot;
    }
  },
  &quot;metadata&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: {
        &quot;timestamp&quot;: 1722097906
      }
    }
  },
  &quot;version&quot;: 17,
  &quot;timestamp&quot;: 1722097906
}
</code></pre>
<ul>
<li>No tópico <code>$aws/things/truckSensor01/shadow/update/delta</code> publicouse unha mensaxe coas diferenzas entre os estados <code>desired</code> da solicitude e <code>reported</code> do estado actual. Esta mensaxe será notificada, como veremos máis adiante, ao dispositivo IoT que está subscrito a este tópico.</li>
</ul>
<pre><code>{
  &quot;version&quot;: 17,
  &quot;timestamp&quot;: 1722097906,
  &quot;state&quot;: {
    &quot;door&quot;: &quot;off&quot;
  },
  &quot;metadata&quot;: {
    &quot;door&quot;: {
      &quot;timestamp&quot;: 1722097906
    }
  }
}
</code></pre>
<ul>
<li>No tópico <code>$aws/things/truckSensor01/shadow/update/documents</code> publicaronse 2 mensaxes. A penúltima das mensaxes é a actualización do estado. A procedencia da última mensaxe publicada no tópico explícase máis adiante.</li>
</ul>
<pre><code>{
  &quot;previous&quot;: {
    &quot;state&quot;: {
      &quot;desired&quot;: {
        &quot;door&quot;: &quot;on&quot;
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;,
        &quot;door&quot;: &quot;on&quot;
      }
    },
    &quot;metadata&quot;: {
      &quot;desired&quot;: {
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722097793
        }
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        },
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722097793
        }
      }
    },
    &quot;version&quot;: 16
  },
  &quot;current&quot;: {
    &quot;state&quot;: {
      &quot;desired&quot;: {
        &quot;door&quot;: &quot;off&quot;
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: &quot;aws-iot&quot;,
        &quot;door&quot;: &quot;on&quot;
      }
    },
    &quot;metadata&quot;: {
      &quot;desired&quot;: {
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722097906
        }
      },
      &quot;reported&quot;: {
        &quot;welcome&quot;: {
          &quot;timestamp&quot;: 1722081284
        },
        &quot;door&quot;: {
          &quot;timestamp&quot;: 1722097793
        }
      }
    },
    &quot;version&quot;: 17
  },
  &quot;timestamp&quot;: 1722097906
}
</code></pre>
<ol start="4">
<li>Comproba o que aconteceu no terminal do ambiente Cloud9 no que está a se executar o <em>script</em> <strong>shadow.sh</strong>.</li>
</ol>
<p><img alt="Resposta no terminal do script shadow.sh ao cambio de estado da sombra" src="../imgs/cloud9_shadowsh03.png" />
<em>Imaxe: resposta no terminal do script <strong>shadow.sh</strong> ao cambio de estado da sombra.</em></p>
<p>O que podemos ver na saída do terminal é o seguinte:</p>
<ul>
<li>O dispositivo IoT ignora a mensaxe que se publicou desde o cliente MQTT no tópico <code>$aws/.../update/accepted</code> porque non contén un campo <code>clientToken</code> e, polo tanto, non se corresponde con ningunha solicitude feita desde o dispositivo.</li>
<li>O dispositivo IoT recibe a notificación da mensaxe publicada no tópico <code>$aws/.../update/delta</code>, e comproba que o valor desexado da propiedade é diferente ao valor local.</li>
<li>O dispositivo IoT actualiza o valor local da sombra e notifica a actualización publicando unha mensaxe no tópico <code>$aws/../update</code>. </li>
</ul>
<ol start="5">
<li>A mensaxe publicada polo dispositivo é procesada polo servizo AWS IoT Device shadow que publica unha mensaxe de aceptación da actualización no tópico <code>$aws/.../update/accepted</code> e outra co documento de cambio de estado da sombra no tópico <code>$aws/.../update/documents</code>. </li>
</ol>
<p>Comproba que esas mensaxes son as últimas publicadas nos correspondentes tópicos e que, a diferenza das que vimos no punto anterior publicadas en resposta á actualización de estado desde o cliente MQTT, estas si que usan o campo <code>clientToken</code>, que permite identificar a(s) resposta(s) que corresponden a unha solicitude.</p>
<p>Por exemplo, no tópico <code>$aws/.../update/accepted</code> a mensaxe sería:</p>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;off&quot;
    },
    &quot;reported&quot;: {
      &quot;door&quot;: &quot;off&quot;
    }
  },
  &quot;metadata&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: {
        &quot;timestamp&quot;: 1722097906
      }
    },
    &quot;reported&quot;: {
      &quot;door&quot;: {
        &quot;timestamp&quot;: 1722097906
      }
    }
  },
  &quot;version&quot;: 18,
  &quot;timestamp&quot;: 1722097906,
  &quot;clientToken&quot;: &quot;3ef97007-db6c-46b6-87ea-1d9cbdf766a1&quot;
}
</code></pre>
<ol start="6">
<li>Nas propiedades da sombra, actualiza as propiedades e comproba os cambios no documento de estado.</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma as capturas 8 e 9 que se piden para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<h3 id="cambio-de-estado-na-sombra-co-dispositivo-iot-desconectado">Cambio de estado na sombra co dispositivo IoT desconectado</h3>
<p>Para cambiar o estado da sombra co dispositivo IoT desconectado fai o seguinte:</p>
<ol>
<li>
<p>No terminal do ambiente Cloud9 no que está a se executar o <em>script</em> <strong>shadow.sh</strong> escribe <code>exit</code> ou <code>quit</code> para parar a execución do <em>script</em>.</p>
</li>
<li>
<p>No cliente MQTT publica no tópico <code>$aws/things/truckSensor01/shadow/update</code> a mensaxe seguinte:</p>
</li>
</ol>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;on&quot;
    }
  }
}
</code></pre>
<ol start="3">
<li>
<p>Repite o paso previo varias veces, cambiando o valor de <strong>door</strong> a <code>on</code> ou <code>off</code> (tamén podes repetir valor). Comproba as mensaxes que se publican nos tópicos <code>$aws/.../update/accepted</code>, <code>$aws/.../update/delta</code> e <code>$aws/.../update/documents</code> cada vez que publiques.</p>
</li>
<li>
<p>Repite o paso 2 co valor de <strong>door</strong> a <code>on</code>. </p>
</li>
<li>
<p>Nas propiedades da sombra, actualiza as propiedades e comproba os cambios no documento de estado. Comproba que aparece un campo <code>delta</code> no estado que indica a diferenza entre os estados <code>desired</code> e <code>reported</code>. </p>
</li>
</ol>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;on&quot;
    },
    &quot;reported&quot;: {
      &quot;welcome&quot;: &quot;aws-iot&quot;,
      &quot;door&quot;: &quot;off&quot;
    },
    &quot;delta&quot;: {
      &quot;door&quot;: &quot;on&quot;
    }
  }
}
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma a captura 10 que se pide para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<ol start="4">
<li>
<p>Repite o paso 2 co valor de <strong>door</strong> a <code>off</code>. </p>
</li>
<li>
<p>Nas propiedades da sombra, actualiza as propiedades e comproba os cambios no documento de estado. Comproba que o campo <code>delta</code> xa non aparece no estado.</p>
</li>
</ol>
<pre><code>{
  &quot;state&quot;: {
    &quot;desired&quot;: {
      &quot;door&quot;: &quot;off&quot;
    },
    &quot;reported&quot;: {
      &quot;welcome&quot;: &quot;aws-iot&quot;,
      &quot;door&quot;: &quot;off&quot;
    }
  }
}
</code></pre>
<ol start="6">
<li>No ambiente Cloud9 executa o <em>script</em> <strong>shadow.sh</strong>. Ao coincidir o estado da sombra co último valor da propiedade no dispositivo este non inicia ningunha actualización. </li>
</ol>
<p><img alt="Saida no terminal do script shadow.sh" src="../imgs/cloud9_shadowsh04.png" />
<em>Imaxe: saida do script <strong>shadow.sh</strong> cando o estado da sombra coincide co do dispositivo.</em></p>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma a captura 11 que se pide para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<ol start="7">
<li>
<p>No terminal escribe <code>exit</code> ou <code>quit</code> para parar a execución do <em>script</em>.</p>
</li>
<li>
<p>Repite o paso 2 co valor de <strong>door</strong> a <code>on</code>. </p>
</li>
<li>
<p>Executa de novo o <em>script</em> <strong>shadow.sh</strong>. O dispositivo solicita o estado actual da sombra publicando unha mensaxe no tópico <code>$aws/.../get</code> e comproba que contén un campo <code>delta</code>, o que lle indica que o estado da sombra mudou mentres estivo desconectado. Ao non haber coincidencia entre o estado da sombra e o do dispositivo, este realiza unha actualización do estado local e a notifica publicando unha mensaxe no tópico <code>$aws/.../update</code>. </p>
</li>
</ol>
<p><img alt="Saida no terminal do script shadow.sh" src="../imgs/cloud9_shadowsh05.png" />
<em>Imaxe: saida do script <strong>shadow.sh</strong> cando o estado da sombra é diferente ao do dispositivo.</em></p>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Antes de continuar toma a captura 12 que se pide para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<ol start="10">
<li>
<p>Comproba no cliente MQTT as mensaxes recibidas nos tópicos da sombra.</p>
</li>
<li>
<p>Comproba o estado da sombra nas propiedades da sombra na consola AWS IoT. </p>
</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Non esquezas tomar a captura 13, a última que se pide para <a href="#xustificacion-da-actividade">xustificar a actividade</a>.</p>
</div>
<h2 id="xustificacion-da-actividade">Xustificación da actividade</h2>
<p>Resume das capturas que hai que tomar para a memoria de xustificación da práctica.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>As capturas teñen que asemellarse ás que se tomaron no curso e na práctica 1. As capturas tomadas na consola AWS teñen que incluír o menú superior no que poida verse o nome de usuario da conta.</p>
</div>
<h3 id="creacion-da-sombra-de-dispositivo_1">Creación da sombra de dispositivo</h3>
<ol>
<li>Na consola IoT as propiedades da cousa <strong>truckSensor01</strong> coa aba <strong>Sombras de dispositivo</strong> escollida na que poida verse a sombra.</li>
</ol>
<h3 id="configuracion-do-exemplo_1">Configuración do exemplo</h3>
<ol start="2">
<li>Ambiente Cloud9 co código do <em>script</em> <strong>shadow.sh</strong> aberto nun terminal.</li>
<li>Propiedades da política AWS IoT modificada.</li>
</ol>
<h3 id="proba-do-exemplo_1">Proba do exemplo</h3>
<h5 id="estado-inicial-da-sombra_1">Estado inicial da sombra</h5>
<ol start="4">
<li>Ambiente Cloud9 coa saída do terminal na que se executou o <em>script</em> <strong>shadow.sh</strong>.</li>
<li>Consola IoT coas propiedades da sombra da cousa <strong>truckSensor01</strong> na que poida verse o estado modificado.</li>
</ol>
<h5 id="cambio-de-estado-no-dispositivo-iot_1">Cambio de estado no dispositivo IoT</h5>
<ol start="6">
<li>Cliente MQTT na consola IoT na que se vexa o contido da mensaxe recibida no tópico <code>$aws/things/truckSensor01/shadow/update/documents</code>.</li>
<li>Consola IoT coas propiedades da sombra da cousa <strong>truckSensor01</strong> na que poida verse o estado modificado.</li>
</ol>
<h5 id="cambio-de-estado-na-sombra-co-dispositivo-iot-conectado_1">Cambio de estado na sombra co dispositivo IoT conectado</h5>
<ol start="8">
<li>Cliente MQTT na consola IoT na que se vexa o contido das dúas últimas mensaxes recibidas no tópico <code>$aws/things/truckSensor01/shadow/update/accepted</code>.</li>
<li>Consola IoT coas propiedades da sombra da cousa <strong>truckSensor01</strong> na que poida verse o estado modificado.</li>
</ol>
<h5 id="cambio-de-estado-na-sombra-co-dispositivo-iot-desconectado_1">Cambio de estado na sombra co dispositivo IoT desconectado</h5>
<ol start="10">
<li>Consola IoT coas propiedades da sombra da cousa <strong>truckSensor01</strong> na que poida verse o estado contendo un campo <code>delta</code>.</li>
<li>Ambiente Cloud9 coa saída do terminal na que se executou o <em>script</em> <strong>shadow.sh</strong> cando o estado da sombra coincide co do dispositivo.</li>
<li>Ambiente Cloud9 coa saída do terminal na que se executou o <em>script</em> <strong>shadow.sh</strong> cando o estado da sombra é diferente ao do dispositivo.</li>
<li>Cliente MQTT na consola IoT na que se vexa o contido das dúas últimas mensaxes recibidas no tópico <code>$aws/things/truckSensor01/shadow/update/delta</code>.</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../actividade_3/" class="btn btn-neutral float-left" title="Actividade 3"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../practica_3/actividade_1/" class="btn btn-neutral float-right" title="Actividade 1">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../actividade_3/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../practica_3/actividade_1/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
